<wxs module="ratingUtils" src="./index.wxs"></wxs>

<!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
<view class="nav-bar">
  <view class="nav-status-bar" style="height: {{statusBarHeight}}px;"></view>
  <view class="nav-title-area">
    <view class="nav-back" bindtap="goBack">
      <text>â€¹</text>
    </view>
    <view class="nav-title">Time Snapshot</view>
  </view>
</view>

<!-- æ»šåŠ¨å†…å®¹åŒºåŸŸ -->
<scroll-view
  class="detail-scroll-wrapper"
  style="height: calc(100vh - {{statusBarHeight + 44}}px - 100rpx); top: {{statusBarHeight + 44}}px;"
  scroll-y
  wx:if="{{record}}"
>
  <view class="detail-page">

    <!-- å›¾ç‰‡è½®æ’­ -->
    <view class="image-swiper-container">
      <swiper
        class="image-swiper"
        indicator-dots
        indicator-color="rgba(255,255,255,0.5)"
        indicator-active-color="#fff"
        bindchange="onImageChange"
      >
        <swiper-item wx:for="{{record.images}}" wx:key="index">
          <image
            class="swiper-image"
            src="{{item}}"
            mode="aspectFill"
            bindtap="onPreviewImage"
          />
        </swiper-item>
      </swiper>
      <view class="image-badge">{{currentImageIndex + 1}} / {{record.images.length}}</view>
      <view class="image-decoration">âœ¨</view>
    </view>

    <!-- å†…å®¹åŒºåŸŸ -->
    <view class="content-container">

      <!-- æ ‡é¢˜å¡ç‰‡ -->
      <view class="title-card">
        <view class="title-text">{{record.title}}</view>
      </view>

      <!-- æ—¶é—´åœ°ç‚¹ä¿¡æ¯ -->
      <view class="info-cards">
        <view class="info-card" wx:if="{{record.date}}">
          <text class="info-emoji">ğŸ“…</text>
          <text class="info-text">{{record.date}}</text>
          <text class="info-text" wx:if="{{record.time}}">{{record.time}}</text>
        </view>
        <view class="info-card" wx:if="{{record.location}}">
          <text class="info-emoji">ğŸ“</text>
          <text class="info-text">{{record.location}}</text>
        </view>
      </view>

      <!-- å‚ä¸äººå‘˜ -->
      <view class="section-block" wx:if="{{record.participants.length > 0}}">
        <view class="section-header">
          <text class="section-emoji">ğŸ‘¥</text>
          <text class="section-label">äººå‘˜</text>
        </view>
        <view class="participants-list">
          <view class="participant-tag" wx:for="{{record.participants}}" wx:key="index">
            {{item}}
          </view>
        </view>
      </view>

      <!-- è¯„åˆ†é¢æ¿ -->
      <view class="section-block rating-section" wx:if="{{record.participants.length > 0}}">
        <view class="section-header">
          <text class="section-emoji">â­</text>
          <text class="section-label">è¯„åˆ†</text>
          <view class="average-rating-badge" wx:if="{{record.averageRating !== undefined}}">
            <text class="average-rating-text">{{averageRatingLabel}}</text>
          </view>
        </view>

        <!-- è¯„åˆ†åˆ—è¡¨ -->
        <view class="rating-list">
          <view class="rating-item" wx:for="{{record.participants}}" wx:key="index" wx:for-item="person">
            <view class="rating-person">
              <text class="rating-avatar">{{ratingUtils.getEmoji(person)}}</text>
              <text class="rating-name">{{person}}</text>
            </view>
            <view class="rating-selector">
              <picker
                mode="selector"
                range="{{ratingOptions}}"
                bindchange="onRatingChange"
                data-person="{{person}}"
                value="{{ratingUtils.getRatingIndex(record.ratings[person])}}"
              >
                <view class="rating-picker {{record.ratings[person] !== undefined ? 'has-rating' : ''}} {{record.ratings[person] <= 2 && record.ratings[person] !== undefined ? 'has-low-rating' : ''}}">
              {{record.ratings[person] !== undefined ? ratingLabels[record.ratings[person]] : 'æœªè¯„åˆ†'}}
                </view>
              </picker>
            </view>
          </view>
        </view>

        <!-- æœ€ç»ˆå¾—åˆ†ç›–ç«  -->
        <view class="final-rating-stamp {{averageRatingLabel === 'æ‹‰å®Œäº†' || averageRatingLabel === 'æ‹‰' || averageRatingLabel === 'npc' ? 'stamp-low' : ''}}" wx:if="{{averageRatingLabel}}">
          {{averageRatingLabel}}
        </view>
      </view>

      <!-- æ´»åŠ¨æè¿° -->
      <view class="section-block" wx:if="{{record.description}}">
        <view class="section-header">
          <text class="section-emoji">ğŸ“</text>
          <text class="section-label">æ‘˜è¦</text>
        </view>
        <view class="description-text">{{record.description}}</view>
      </view>

      <!-- è¯„è®ºåŒº -->
      <view class="section-block comments-section">
        <view class="section-header">
          <text class="section-emoji">ğŸ’¬</text>
          <text class="section-label">è¯„è®º ({{comments.length}})</text>
        </view>

        <!-- è¯„è®ºåˆ—è¡¨ -->
        <view class="comments-list">
          <view class="comment-item" wx:for="{{comments}}" wx:key="_id">
            <view class="comment-avatar">{{item.author.charAt(0)}}</view>
            <view class="comment-body">
              <view class="comment-header">
                <text class="comment-author">{{item.author}}</text>
                <text class="comment-time">{{item.time}}</text>
              </view>
              <text class="comment-content">{{item.content}}</text>
            </view>
          </view>

          <!-- ç©ºçŠ¶æ€ -->
          <view class="empty-comments" wx:if="{{comments.length === 0}}">
            <text class="empty-emoji">ğŸŒ¸</text>
            <text class="empty-text">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘~</text>
          </view>
        </view>
      </view>

    </view>
  </view>
</scroll-view>

<!-- åº•éƒ¨è¯„è®ºè¾“å…¥ -->
<view class="comment-bar">
  <view class="comment-input-wrapper">
    <input
      class="comment-input"
      placeholder="å†™ç‚¹ä»€ä¹ˆ..."
      value="{{commentInput}}"
      bindinput="onCommentInput"
      confirm-type="send"
      bindconfirm="onSubmitComment"
    />
    <view class="send-btn" bindtap="onSubmitComment" wx:if="{{!submitting}}">
      <text class="send-icon">ğŸš€</text>
    </view>
    <view class="send-btn sending" wx:else>ğŸ€</view>
  </view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading-page" wx:if="{{!record}}" style="padding-top: {{statusBarHeight + 44}}px;">
  <view class="loading-icon">ğŸ€</view>
  <view class="loading-text">åŠ è½½ä¸­...</view>
</view>
